<Project>
  <!-- Add validation for netcoreapp3.1 to package build and testing 
      This would get moved to arcade with other validate frameworks and should get removed from here. -->
  <ItemGroup>
    <DefaultValidateFramework Include="netcoreapp3.1">
      <RuntimeIDs>@(NETCoreApp30RIDs)</RuntimeIDs>
    </DefaultValidateFramework>
  </ItemGroup>

  <!--     There are some packages where we require only one ref for a specific framework to be present. In order to avoid problems with this package when targetting 
           dektop with RAR we will make sure there are no exclude=compile references in the package.
    For more info, please check issues:
     - https://github.com/dotnet/corefx/issues/32457  -> Why reference assets were removed from the package
     - https://github.com/aspnet/AspNetCore/issues/11206  -> Why ASP.NET required a ref to be added back for netcoreapp
     - https://github.com/dotnet/corefx/issues/38729  -> Issue tracking to work of readding a ref to netcoreapp -->
  <Target Name="RemoveExcludeCompileFromPackageDependencies" Condition="'$(RemoveExcludeCompileFromPackageDependencies)' == 'true'" DependsOnTargets="GetPackageDependencies" BeforeTargets="ValidateExcludeCompileDesktop">
    <ItemGroup>
      <Dependency>
        <Exclude></Exclude>
      </Dependency>
    </ItemGroup>    
  </Target>

  <Target Name="ValidateExcludeCompileDesktop"
          AfterTargets="GetPackageDependencies"
          Inputs="%(Dependency.Identity);%(Dependency.TargetFramework)" 
          Outputs="unused"
          Condition="'$(SkipValidatePackage)' != 'true'">
    <PropertyGroup>
      <_excludeCompile Condition="@(Dependency->WithMetadataValue('Exclude', 'Compile')->Count()) == @(Dependency->Count())">true</_excludeCompile>
    </PropertyGroup>
    <Error Text="Cannot have Exclude=Compile dependencies when targeting a desktop TFM. @(Dependency). You can exclude the reference asset in the package by setting the ExcludeReferenceAssets property to true in your project." 
           Condition="$([System.String]::Copy('%(Dependency.TargetFramework)').StartsWith('net4')) AND 
                      '$(_excludeCompile)' == 'true' AND
                      '%(Dependency.Identity)' != '_._'" />
  </Target>

  <Target Name="BlockStable" Condition="'$(BlockStable)' == 'true'" AfterTargets="CalculatePackageVersion">
    <!-- DO NOT ship this packages as stable -->
    <Error Condition="!$(PackageVersion.Contains('-'))" Text="Package $(Id) should not be built stable" />
  </Target>

  <!-- Get the package version without pre-release -->
  <Target Name="GetPackageIdentityWithoutPrerelease"
          Returns="@(_PackageIdentityWithoutPrerelease)">
    <ItemGroup>
      <_PackageIdentityWithoutPrerelease Include="$(Id)">
        <Version>$(PackageVersion)</Version>
        <BlockStable>$(BlockStable)</BlockStable>
      </_PackageIdentityWithoutPrerelease>
    </ItemGroup>

    <ItemGroup Condition="'@(BuildRID)' != ''">
      <_PackageIdentityWithoutPrerelease Include="@(BuildRID->'runtime.%(Identity).$(Id)')">
        <Version>$(PackageVersion)</Version>
        <BlockStable>$(BlockStable)</BlockStable>
      </_PackageIdentityWithoutPrerelease>
    </ItemGroup>
  </Target>

  <PropertyGroup>
    <VersionSuffix>$(_PreReleaseLabel)$(_BuildNumberLabels)</VersionSuffix>
  </PropertyGroup>
</Project>