<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Target Name="IterateProjects">
    <!-- To Serialize we use msbuild's batching functionality '%' to force it to batch all similar projects with the same identity 
         however since the project names are unique it will essentially force each to run in its own batch -->
    <MSBuild Targets="$(IterateProjectsTargets)"
             Projects="@(Project)"
             Condition="'$(SerializeProjects)'=='true'"
             Properties="Dummy=%(Identity);$(IterateProjectsProperties)"
             ContinueOnError="ErrorAndContinue" />

    <MSBuild Targets="$(IterateProjectsTargets)"
             Projects="@(Project)"
             Condition="'$(SerializeProjects)'!='true'"
             Properties="$(IterateProjectsProperties)"
             BuildInParallel="true"
             ContinueOnError="ErrorAndContinue" />

    <!-- Given we ErrorAndContinue we need to propagate the error if the overall task failed -->
    <Error Condition="'$(MSBuildLastTaskResult)'=='false'" />
  </Target>
  
  <Target Name="BuildAllProperties">
    <PropertyGroup>
      <DefaultBuildAllTarget Condition="'$(DefaultBuildAllTarget)'==''">$(MSBuildProjectDefaultTargets)</DefaultBuildAllTarget>
      <IterateProjectsTargets>$(DefaultBuildAllTarget)</IterateProjectsTargets>
      <IterateProjectsProperties>DefaultBuildAllTarget=$(DefaultBuildAllTarget);BuildAllProjects=true</IterateProjectsProperties>
    </PropertyGroup>
  </Target>

  <Target Name="CleanAllProperties">
    <PropertyGroup>
      <DefaultCleanAllTarget Condition="'$(DefaultCleanAllTarget)'==''">Clean</DefaultCleanAllTarget>
      <IterateProjectsTargets>$(DefaultCleanAllTarget)</IterateProjectsTargets>
      <IterateProjectsProperties>CleanAllProjects=true</IterateProjectsProperties>
    </PropertyGroup>
  </Target>

  <Target Name="RestoreAllProperties">
    <Message Importance="High" Text="Restoring project packages..." />

    <PropertyGroup>
      <DefaultRestoreAllPackagesTarget Condition="'$(DefaultRestoreAllPackagesTarget)'==''">RestorePackages</DefaultRestoreAllPackagesTarget>
      <IterateProjectsTargets>$(DefaultRestoreAllPackagesTarget)</IterateProjectsTargets>
      <IterateProjectsProperties>RestoreAllPackages=true</IterateProjectsProperties>
    </PropertyGroup>
  </Target>

  <PropertyGroup>
    <TraversalBuildDependsOn>
      BuildAllProperties;
      IterateProjects;
      $(TraversalBuildDependsOn);
    </TraversalBuildDependsOn>

    <TraversalCleanDependsOn>
      CleanAllProperties;
      IterateProjects;
      $(TraversalCleanDependsOn);
    </TraversalCleanDependsOn>

    <TraversalRestorePackagesDependsOn>
      RestoreAllProperties;
      IterateProjects;
      $(TraversalRestorePackagesDependsOn)
    </TraversalRestorePackagesDependsOn>
  </PropertyGroup>

  <Target Name="Build" DependsOnTargets="$(TraversalBuildDependsOn)" />

  <Target Name="Clean" DependsOnTargets="$(TraversalCleanDependsOn)" />

  <Target Name="Rebuild" DependsOnTargets="Clean;Build" />

  <Target Name="RestorePackages" DependsOnTargets="$(TraversalRestorePackagesDependsOn)" />

</Project>
