<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <ItemGroup>
    <TargetingPackDirs Include="$(BinDir)netcoreapp/TargetingPack" />
    <AdditionalReferencePaths Include="@(TargetingPackDirs)" />
  </ItemGroup>

  <PropertyGroup>
    <TestRuntimeDir>$(BinDir)/tests/test-runtime/netcoreapp</TestRuntimeDir>
    <ContractOutputPath>$(BinDir)netcoreapp/TargetingPack</ContractOutputPath>
    <FrameworkPathOverride>$(ContractOutputPath)</FrameworkPathOverride>
    <AssemblySearchPaths>$(AssemblySearchPaths);$(ContractOutputPath);{RawFileName}</AssemblySearchPaths>
  </PropertyGroup>

  <!-- Adds test references to the targeting pack and runtime assemblies. -->
  <Target Name="AddTestTargetingPackReferences" BeforeTargets="ResolveAssemblyReferences" Condition="'$(IsTestProject)' == 'true'">
    <ItemGroup>
      <!-- Whitelisted runtime assemblies that are OK to reference. -->
      <RuntimeReferencedAssemblyNames Include="xunit.core" />
      <RuntimeReferencedAssemblyNames Include="Xunit.NetCore.Extensions" />
      <RuntimeReferencedAssemblyNames Include="xunit.assert" />
      <RuntimeReferencedAssemblyNames Include="xunit.abstractions" />

      <!-- Add Reference's to all files in the targeting pack folder, and to whitelisted items from the group above in the runtime folder. -->
      <TargetingPackItems Include="%(TargetingPackDirs.Identity)/*" />
      <Reference Include="%(TargetingPackItems.Filename)" Exclude="System.Private.CoreLib" /> <!-- TODO: System.Private.CoreLib shouldn't even be in the targeting pack. -->
      <Reference Include="@(RuntimeReferencedAssemblyNames)" />
    </ItemGroup>

    <!-- Allow tests to reference items from the runtime directory -->
    <PropertyGroup>
      <AssemblySearchPaths>$(AssemblySearchPaths);$(RuntimeDir)</AssemblySearchPaths>
    </PropertyGroup>
  </Target>

</Project>
