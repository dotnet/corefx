<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!-- Imported from $(BuildDir)dir.traversal.targets -->

  <Target Name="GenerateAllTestProjectJsons">
    <PropertyGroup>
      <DefaultGenerateAllTestProjectJsonsTarget Condition="'$(DefaultGenerateAllTestProjectJsonsTarget)' == ''">GenerateAllTestProjectJsons</DefaultGenerateAllTestProjectJsonsTarget>
    </PropertyGroup>

    <ItemGroup>
      <GeneratedProject Include="@(Project)">
        <AdditionalProperties>GeneratedTargetGroup=%(Project.TargetGroup);GeneratedOSGroup=%(Project.OSGroup);%(Project.AdditionalProperties)</AdditionalProperties>
      </GeneratedProject>
    </ItemGroup>

    <!-- To Serialize we use msbuild's batching functionality '%' to force it to batch all similar projects with the same identity
         however since the project names are unique it will essentially force each to run in its own batch -->
    <MSBuild Targets="$(DefaultGenerateAllTestProjectJsonsTarget)"
             Projects="@(GeneratedProject)"
             Condition="'$(SerializeProjects)' != 'true'"
             Properties="GenerateAllTestProjectJsons=$(DefaultGenerateAllTestProjectJsonsTarget)"
             BuildInParallel="true"
             ContinueOnError="ErrorAndContinue" />

    <MSBuild Targets="$(DefaultGenerateAllTestProjectJsonsTarget)"
             Projects="@(GeneratedProject)"
             Condition="'$(SerializeProjects)' == 'true' AND '%(Identity)' != ''"
             Properties="GenerateAllTestProjectJsons=$(DefaultGenerateAllTestProjectJsonsTarget)"
             ContinueOnError="ErrorAndContinue" />

    <!-- Given we ErrorAndContinue we need to propagate the error if the overall task failed -->
    <Error Condition="'$(MSBuildLastTaskResult)'=='false'" />
  </Target> 
</Project>
